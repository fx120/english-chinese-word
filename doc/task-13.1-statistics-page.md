# Task 13.1 - 统计页面实现文档

## 任务概述

实现统计页面，显示用户的学习统计数据，包括总体统计、今日学习、学习曲线图表和词表学习进度。

## 实现时间

2024年（任务执行时间）

## 需求映射

本任务实现以下需求：
- 需求 12.1: 显示总学习天数
- 需求 12.2: 显示连续学习天数
- 需求 12.3: 显示总学习单词数
- 需求 12.4: 显示已掌握单词数
- 需求 12.5: 显示待复习单词数
- 需求 12.6: 显示每个词表的学习进度
- 需求 12.7: 显示最近7天学习曲线图表
- 需求 12.8: 显示今日学习统计

## 实现文件

### 前端文件（app/目录）

1. **app/lib/ui/pages/statistics_page.dart**
   - 统计页面主文件
   - 显示所有统计数据和图表
   - 集成 StatisticsManager

## 功能实现

### 1. 总体统计卡片

显示以下统计数据：
- **总学习天数**: 用户累计学习的天数
- **连续学习天数**: 当前连续学习的天数（带火焰图标）
- **总学习单词数**: 已学习的单词总数（包括已掌握和需复习）
- **已掌握单词数**: 状态为"已掌握"的单词数量
- **待复习单词数**: 到期需要复习的单词数量

每个统计项都有对应的图标和颜色标识，便于用户快速识别。

### 2. 今日学习统计卡片

显示今天的学习情况：
- **新学单词**: 今天首次学习的单词数量
- **复习单词**: 今天复习的单词数量
- **总计**: 今天学习和复习的单词总数

### 3. 最近7天学习曲线图表

使用 fl_chart 库绘制折线图，显示：
- **蓝色曲线**: 每天新学习的单词数量
- **绿色曲线**: 每天复习的单词数量
- **X轴**: 显示日期（月/日格式）
- **Y轴**: 显示单词数量
- **交互**: 点击数据点显示详细数值

图表特性：
- 自动计算Y轴最大值（向上取整到10的倍数）
- 曲线平滑显示
- 区域填充（半透明）
- 触摸提示显示具体数值

### 4. 词表学习进度卡片

显示所有词表的学习进度：
- **词表名称**: 显示词表的名称
- **进度百分比**: 显示学习进度（0-100%）
- **进度条**: 可视化显示进度
  - 红色: 0-49%
  - 橙色: 50-79%
  - 绿色: 80-100%
- **单词数量**: 显示词表的总单词数

### 5. 刷新功能

- 顶部导航栏提供刷新按钮
- 支持下拉刷新
- 刷新时重新加载所有统计数据

### 6. 错误处理

- 加载失败时显示错误信息
- 提供重试按钮
- 友好的错误提示

## 技术实现细节

### 数据加载流程

1. 初始化 LocalDatabase 和 StatisticsManager
2. 调用 `updateStatistics()` 更新统计数据
3. 获取用户统计数据 `getUserStatistics()`
4. 获取最近7天学习记录 `getDailyRecords(7)`
5. 获取所有词表 `getAllVocabularyLists()`
6. 遍历词表获取每个词表的学习进度 `getVocabularyListProgress(listId)`
7. 获取待复习单词数量 `getTotalDueReviewCount()`

### 图表实现

使用 fl_chart 包的 LineChart 组件：
- 配置网格线、坐标轴标题
- 创建两条折线（新学单词和复习单词）
- 设置曲线样式、颜色、区域填充
- 配置触摸交互和提示框

### 状态管理

使用 StatefulWidget 管理页面状态：
- `_isLoading`: 加载状态
- `_errorMessage`: 错误信息
- `_userStats`: 用户统计数据
- `_dailyRecords`: 每日学习记录
- `_vocabularyLists`: 词表列表
- `_listProgress`: 词表进度映射
- `_dueReviewCount`: 待复习单词数

## 依赖项

### Flutter 包
- `flutter/material.dart`: Material Design UI组件
- `fl_chart: ^0.65.0`: 图表库（已在 pubspec.yaml 中配置）

### 项目内部依赖
- `StatisticsManager`: 统计管理器
- `LocalDatabase`: 本地数据库
- `UserStatistics`: 用户统计模型
- `DailyRecord`: 每日学习记录模型
- `VocabularyList`: 词表模型

## UI设计

### 布局结构
```
StatisticsPage
├── AppBar (标题 + 刷新按钮)
└── ScrollView
    ├── 总体统计卡片
    │   ├── 总学习天数
    │   ├── 连续学习天数
    │   ├── 总学习单词数
    │   ├── 已掌握单词数
    │   └── 待复习单词数
    ├── 今日学习统计卡片
    │   ├── 新学单词
    │   ├── 复习单词
    │   └── 总计
    ├── 最近7天学习曲线卡片
    │   └── 折线图
    └── 词表学习进度卡片
        └── 进度列表
            ├── 词表1 (名称 + 进度条 + 百分比)
            ├── 词表2
            └── ...
```

### 颜色方案
- **蓝色**: 总学习天数、新学单词
- **橙色**: 连续学习天数
- **绿色**: 总学习单词数、复习单词
- **紫色**: 已掌握单词数、今日总计
- **红色**: 待复习单词数、低进度词表

## 测试建议

### 单元测试
1. 测试数据加载逻辑
2. 测试错误处理
3. 测试日期格式化
4. 测试进度颜色计算

### Widget测试
1. 测试页面渲染
2. 测试刷新功能
3. 测试错误视图显示
4. 测试空数据处理

### 集成测试
1. 测试完整的数据加载流程
2. 测试与 StatisticsManager 的集成
3. 测试图表交互

## 已知限制

1. 图表仅显示最近7天数据
2. 词表进度计算不包括已排除的单词
3. 待复习单词数仅统计到期的单词

## 后续优化建议

1. 添加更多时间范围选项（30天、90天）
2. 添加词表进度排序功能
3. 添加学习目标设置和进度提醒
4. 添加学习成就系统
5. 添加数据导出功能
6. 优化图表性能（大数据量时）
7. 添加更多图表类型（饼图、柱状图）

## 验收标准检查

- [x] 显示总学习天数
- [x] 显示连续学习天数
- [x] 显示总学习单词数
- [x] 显示已掌握单词数
- [x] 显示待复习单词数
- [x] 显示每个词表的学习进度
- [x] 显示最近7天学习曲线图表
- [x] 显示今日学习统计
- [x] 集成StatisticsManager
- [x] 支持刷新功能
- [x] 错误处理和提示

## 总结

统计页面成功实现了所有需求的功能，为用户提供了全面的学习数据可视化。通过清晰的卡片布局、直观的图表展示和友好的交互设计，用户可以轻松了解自己的学习进度和效果。页面集成了 StatisticsManager，确保数据的准确性和实时性。
